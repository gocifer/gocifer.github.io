(window.webpackJsonp=window.webpackJsonp||[]).push([[32],{447:function(t,s,a){"use strict";a.r(s);var e=a(6),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"iptables"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#iptables"}},[t._v("#")]),t._v(" iptables")]),t._v(" "),a("h1",{attrs:{id:"iptables-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#iptables-2"}},[t._v("#")]),t._v(" iptables")]),t._v(" "),a("p",[t._v("[toc]")]),t._v(" "),a("h2",{attrs:{id:"介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#介绍"}},[t._v("#")]),t._v(" 介绍")]),t._v(" "),a("ul",[a("li",[t._v("IPTABLES是与3.5版本Linux内核集成的IP信息包过滤系统,在redhat7.1 和centos7.1以上都内置装有。")]),t._v(" "),a("li",[t._v("iptables的最大优点是它可以配置有状态的防火墙，有四种有效状态，名称分别为ESTABLISHED、INVALID、NEW和RELATED。")]),t._v(" "),a("li",[t._v("iptables的另一个重要优点是，它使用户可以完全控制防火墙配置和信息包过滤。您可以定制自己的规则来满足您的特定需求，从而只允许您想要的网络流量进入系统。")]),t._v(" "),a("li",[t._v("iptables是用来设置、维护和检查Linux内核的IP包过滤规则的，同时iptables是免费的，这对于那些想要节省费用的人来说十分理想，它可以代替昂贵的防火墙解决方案。")])]),t._v(" "),a("h2",{attrs:{id:"四种状态"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四种状态"}},[t._v("#")]),t._v(" 四种状态")]),t._v(" "),a("blockquote",[a("p",[t._v("iptables的最大优点是它可以配置有状态的防火墙，有四种有效状态，名称分别为ESTABLISHED、INVALID、NEW和RELATED。")])]),t._v(" "),a("ul",[a("li",[t._v("状态ESTABLISHED指出该信息包属于已建立的连接，该连接一直用于发送和接收信息包并且完全有效")]),t._v(" "),a("li",[t._v("状态INVALID指出该信息包与任何已知的流或连接都不相关联，它可能包含错误的数据或头")]),t._v(" "),a("li",[t._v("状态NEW意味着该信息包已经或将启动新的连接，或者它与尚未用于发送和接收信息包的连接相关联")]),t._v(" "),a("li",[t._v("状态RELATED表示该信息包正在启动新连接，以及它与已建立的连接相关联。")])]),t._v(" "),a("h2",{attrs:{id:"结构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#结构"}},[t._v("#")]),t._v(" 结构")]),t._v(" "),a("blockquote",[a("p",[t._v("iptables有四张表raw、mangle、nat、filter，都有独立的相应链表。")])]),t._v(" "),a("ul",[a("li",[t._v("状态跟踪表(raw)\n"),a("ul",[a("li",[t._v("prerouting")]),t._v(" "),a("li",[t._v("output")])])]),t._v(" "),a("li",[t._v("包标记表(mangle)\n"),a("ul",[a("li",[t._v("prerouting")]),t._v(" "),a("li",[t._v("postrouting")]),t._v(" "),a("li",[t._v("input")]),t._v(" "),a("li",[t._v("output")]),t._v(" "),a("li",[t._v("forward")])])]),t._v(" "),a("li",[t._v("地址转换表(nat)\n"),a("ul",[a("li",[t._v("prerouting")]),t._v(" "),a("li",[t._v("postrouting")]),t._v(" "),a("li",[t._v("output")])])]),t._v(" "),a("li",[a("strong",[t._v("过滤表(filter)")]),t._v(" "),a("ul",[a("li",[t._v("INPUT")]),t._v(" "),a("li",[t._v("FORWARD")]),t._v(" "),a("li",[t._v("OUTPUT")])])])]),t._v(" "),a("h2",{attrs:{id:"常见的防火墙设置类型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#常见的防火墙设置类型"}},[t._v("#")]),t._v(" 常见的防火墙设置类型")]),t._v(" "),a("p",[t._v("根据防火墙保护的对象不同，防火墙可以分为主机型防火墙与网络型防火墙")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("主机型防火墙，主要保护的是服务器本机（过滤威胁本机的数据包）。")])]),t._v(" "),a("li",[a("p",[t._v("网络防火墙，主要保护的是防火墙后面的其他服务器，如web服务器、FTP服务器等。")])])]),t._v(" "),a("h2",{attrs:{id:"流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#流程"}},[t._v("#")]),t._v(" 流程")]),t._v(" "),a("p",[t._v("按照规则链内匹配顺序匹配")]),t._v(" "),a("ul",[a("li",[t._v("顺序匹配，匹配即停止")]),t._v(" "),a("li",[t._v("若无任何匹配，按照该链的默认规则匹")])]),t._v(" "),a("h2",{attrs:{id:"基本用法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#基本用法"}},[t._v("#")]),t._v(" 基本用法")]),t._v(" "),a("blockquote",[a("p",[t._v("iptables  [-t 表名] 选项 [链名（大写）] 条件 [-j 目标操作(大写）]")])]),t._v(" "),a("h3",{attrs:{id:"常用规则"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#常用规则"}},[t._v("#")]),t._v(" 常用规则")]),t._v(" "),a("ul",[a("li",[t._v("可以不指定表，默认为filter表")]),t._v(" "),a("li",[t._v("可以不指定链，默认为对应表的所有链")]),t._v(" "),a("li",[t._v("除非设置默认策略，否则必须指定匹配条件")]),t._v(" "),a("li",[t._v("选项／链名用大写字母／目标操作用大写字母，其余都小写")])]),t._v(" "),a("h3",{attrs:{id:"常见目标操作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#常见目标操作"}},[t._v("#")]),t._v(" 常见目标操作")]),t._v(" "),a("ul",[a("li",[t._v("ACCEPT：允许通过/放行")]),t._v(" "),a("li",[t._v("DROP：直接丢弃，不给出任何回应")]),t._v(" "),a("li",[t._v("REJECT：拒绝过，必要时会给出提示")]),t._v(" "),a("li",[t._v("LOG：记录日志，然后传给下一条规则")])]),t._v(" "),a("h3",{attrs:{id:"常用的iptables命令选项"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#常用的iptables命令选项"}},[t._v("#")]),t._v(" 常用的iptables命令选项")]),t._v(" "),a("div",{staticStyle:{border:"black"}},[a("table",[a("tr",[a("td",[t._v("class")]),t._v(" "),a("td",[t._v("option")]),t._v(" "),a("td",[t._v("function")])]),t._v(" "),a("tr",[a("td",{attrs:{rowspan:"2"}},[t._v("ADD")]),t._v(" "),a("td",[t._v("-A")]),t._v(" "),a("td",[t._v("add a rule from the end")])]),t._v(" "),a("tr",[a("td",[t._v("-I")]),t._v(" "),a("td",[t._v("add a rule from the front")])]),t._v(" "),a("tr",[a("td",{attrs:{rowspan:"3"}},[t._v("CHECK")]),t._v(" "),a("td",[t._v("-L")]),t._v(" "),a("td",[t._v("list all the rules")])]),t._v(" "),a("tr",[a("td",[t._v("-n")]),t._v(" "),a("td",[t._v("display the address and port as num")])]),t._v(" "),a("tr",[a("td",[t._v("--line-numbers")]),t._v(" "),a("td",[t._v("display the line number")])]),t._v(" "),a("tr",[a("td",{attrs:{rowspan:"2"}},[t._v("DELETE")]),t._v(" "),a("td",[t._v("-D")]),t._v(" "),a("td",[t._v("delete the selected order rules")])]),t._v(" "),a("tr",[a("td",[t._v("-F")]),t._v(" "),a("td",[t._v("clear all the rules")])]),t._v(" "),a("tr",[a("td",{attrs:{rowspan:"2"}},[t._v("OTHER")]),t._v(" "),a("td",[t._v("-P")]),t._v(" "),a("td",[t._v("set the default rule for selected chain")])]),t._v(" "),a("tr",[a("td",[t._v("-X")]),t._v(" "),a("td",[t._v(" 清除预设表filter中使用者自定链中的规则（清除默认规则）")])])])]),t._v(" "),a("h3",{attrs:{id:"常用的iptables命令条件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#常用的iptables命令条件"}},[t._v("#")]),t._v(" 常用的iptables命令条件")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("参数")]),t._v(" "),a("th",[t._v("作用")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("-s")]),t._v(" "),a("td",[t._v("匹配来源地址IP/MASK，加叹号“!”表示除这个IP外")])]),t._v(" "),a("tr",[a("td",[t._v("-d")]),t._v(" "),a("td",[t._v("匹配目标地址")])]),t._v(" "),a("tr",[a("td",[t._v("-i网卡名称")]),t._v(" "),a("td",[t._v("匹配从这块网卡流入的数据")])]),t._v(" "),a("tr",[a("td",[t._v("-o网卡名称")]),t._v(" "),a("td",[t._v("匹配从这块网卡流出的数据")])]),t._v(" "),a("tr",[a("td",[t._v("-p")]),t._v(" "),a("td",[t._v("匹配协议，如TCP、UDP、ICMP")])]),t._v(" "),a("tr",[a("td",[t._v("--dport num")]),t._v(" "),a("td",[t._v("匹配目标端口号")])]),t._v(" "),a("tr",[a("td",[t._v("--sport num")]),t._v(" "),a("td",[t._v("匹配来源端口号")])])])]),t._v(" "),a("h3",{attrs:{id:"常用规则示例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#常用规则示例"}},[t._v("#")]),t._v(" 常用规则示例")]),t._v(" "),a("h4",{attrs:{id:"添加新规则"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#添加新规则"}},[t._v("#")]),t._v(" 添加新规则")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("#iptables -t filter -A INPUT -p tcp -j ACCEPT   //允许接收tcp协议进来的数据包\n(在表filter的INPUT链中追加规则)(-A末尾追加这条规则）\n\n#iptables -I INPUT -p utp -j ACCEPT     //允许接收udp协议进来的数据包\n(没写表名时，默认是指filter)(在INPUT规则表中首行插入这条规则）\n\n#iptables-I INPUT 2 -p icmp -j ACCEPT   //允许接收icmp协议进来的数据包\n(没写表名时，默认是指filter)(在INPUT规则表中第2行插入这条规则）\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br")])]),a("h4",{attrs:{id:"查看规则"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查看规则"}},[t._v("#")]),t._v(" 查看规则")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("#iptables -nL -t nat   //查看nat的全部规则表\n\n#iptables -nL POSTROUTING -t nat //查看nat表中POSTROUTING链的规则表\n\n#iptables -L POSTROUTING -t nat --line-numbers //以规则序号的方式查看\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("h4",{attrs:{id:"删除规则"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#删除规则"}},[t._v("#")]),t._v(" 删除规则")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("#iptables -D INPUT 1 -t filter //删除表filter中INPUT链的第1条规则（-t filter没写时，默认为filter表）\n\n# iptables -D POSTROUTING 2 -t nat  //删除表nat中POSTROUTING链中的第2条规则\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("h4",{attrs:{id:"清空规则"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#清空规则"}},[t._v("#")]),t._v(" 清空规则")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("#iptables -F //默认为filter表\n\n#iptables -t nat -F\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("h4",{attrs:{id:"设置默认规则"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#设置默认规则"}},[t._v("#")]),t._v(" 设置默认规则")]),t._v(" "),a("blockquote",[a("ul",[a("li",[t._v("当用户添加的规则都不匹配时，为匹配默认规则")]),t._v(" "),a("li",[t._v("所有链的始默认规则均为ACCEPT（接收状态）")]),t._v(" "),a("li",[t._v("通过-P选项可重置默认规则，常用两种状态ACCEPT或DROP(不可设置reject)")])])]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("#iptable -t nat -P POSTROUTING DROP        //将nat表中POSTROUTING链默认规则设置为DROP（弃包状态）\n#iptables -t filter -P INPUT ACCEPT\n//将filter表中INPUT链默认规则设置为ACCEPT（接收状态）\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("h3",{attrs:{id:"常见的扩展条件类型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#常见的扩展条件类型"}},[t._v("#")]),t._v(" 常见的扩展条件类型")]),t._v(" "),a("blockquote",[a("p",[t._v("前提条件：有对应的防火墙模块支持")])]),t._v(" "),a("p",[t._v("基本用法：")]),t._v(" "),a("blockquote",[a("p",[a("code",[t._v("-m 扩展模块 --扩展条件 条件值")])])]),t._v(" "),a("div",[a("tr",[a("td",[t._v("class")]),t._v(" "),a("td",[t._v("option")]),t._v(" "),a("td",[t._v("function")])]),t._v(" "),a("tr",[a("td",{attrs:{rowspan:"6"}},[t._v("extension")]),t._v(" "),a("td",[t._v("status")]),t._v(" "),a("td",[t._v("-m state --state value")])]),t._v(" "),a("tr",[a("td",[t._v("mac")]),t._v(" "),a("td",[t._v("-m mac --mac-source value")])]),t._v(" "),a("tr",[a("td",{attrs:{rowspan:"2"}},[t._v("multiport")]),t._v(" "),a("td",[t._v("-m multiport --sport sourceport")])]),t._v(" "),a("tr",[a("td",[t._v("-m multiport --dport des port")])]),t._v(" "),a("tr",[a("td",{attrs:{rowspan:"2"}},[t._v("ip range")]),t._v(" "),a("td",[t._v("-m iprange --src-range a,b,c:d")])]),t._v(" "),a("tr",[a("td",[t._v("-m iprange --dst-range a,b,c:d")])])]),t._v(" "),a("p",[t._v("eg：-m mac --mac-source 00:0D:33:88:BC:66")]),t._v(" "),a("h3",{attrs:{id:"扩展规则示例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#扩展规则示例"}},[t._v("#")]),t._v(" 扩展规则示例")]),t._v(" "),a("ul",[a("li",[t._v("拒绝某主机的访问，锁定该主机的MAC地址，这样不管变成什么IP都无法访问本机")])]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("#iptables -A INPUT -m mac --mac-source 00:0D:33:88:BC:66 -j DROP \n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("ul",[a("li",[t._v("过滤无效的数据包")])]),t._v(" "),a("p",[t._v("假设有人进入了服务器，或者有病毒木马程序，它可以通过22，80端口像服务器外传送数据。\n它的这种方式就和我们正常访问22，80端口区别。它发向外发的数据不是我们通过访问网页请求而回应的数据包。")]),t._v(" "),a("p",[t._v("下面要禁止这些没有通过请求回应的数据包，统统把它们堵住掉:")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("iptables -A OUTPUT -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("iptables 提供了一个参数 是检查状态的，下面我们来配置下 22 和 80 端口，防止无效的数据包。")]),t._v(" "),a("ul",[a("li",[t._v("利用iptables，我们可以对日常用到的服务项进行安全管理，比如设定只能通过指定网段、由指定网口通过SSH连接本机")])]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("iptables -A INPUT -i eth0 -p tcp -s 192.168.100.0/24 --dport 22 -m state --state NEW,ESTABLESHED -j ACCEPT\niptables -A OUTPUT -o eth0 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[t._v("若要支持由本机通过SSH连接其他机器，由于在本机端口建立连接，因而还需要设置以下规则")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("iptables -A INPUT -i eth0 -p tcp -s 192.168.100.0/24 --dport 22 -m state --state ESTABLESHED -j ACCEPT\niptables -A OUTPUT -o eth0 -p tcp --sport 22 -m state --state NEW,ESTABLISHED -j ACCEPT\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[t._v("类似的，对于HTTP/HTTPS(80/443)、pop3(110)、rsync(873)、MySQL(3306)等基于tcp连接的服务，也可以参照上述命令配置。")]),t._v(" "),a("ul",[a("li",[t._v("一条规则开放多个端口")])]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("#iptables -A INPUT -p tcp -m muliport -dport 21:23,25,80,110,16500:16800 -j ACCEPT\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("//先指定大的协议如tcp，然后再指定扩展协议\n//21:23指21到23间的所有端口，16500：16800同理,不连续的用,分开")]),t._v(" "),a("ul",[a("li",[t._v("功能：根据IP范围指定可以访问本机相关端口的IP段（例如SSH远程登陆本机）")])]),t._v(" "),a("blockquote",[a("p",[t._v("先写允许访问的IP段，然后再写禁止IP段")])]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("#iptables -A INPUT -p tcp -dport 22 -m iprange --src-range 192.168.8.20-192.168.8.60 -j ACCEPT \n//先写允许20－60间的主机可以通过22端口远程访问本机\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("#ptables -A INPUT -p tcp --dport 22 -s 92.168.4.0/24 -j DROP\n//当进来的IP不符合第一条规则时，会开始中匹配第二条，就在第二条上执行禁止4.0／24网段的访问。相当于只允许第一条的人访问。\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("ul",[a("li",[t._v("网口转发配置")])]),t._v(" "),a("p",[t._v("对于用作防火墙或网关的服务器，一个网口连接到公网，其他网口的包转发到该网口实现内网向公网通信，假设eth0连接内网，eth1连接公网，配置规则如下：")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("iptables -A FORWARD -i eth0 -o eth1 -j ACCEPT\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("ul",[a("li",[t._v("端口转发配置")])]),t._v(" "),a("p",[t._v("对于端口，我们也可以运用iptables完成转发配置：")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("iptables -t nat -A PREROUTING -p tcp -d 192.168.102.37 --dport 422 -j DNAT --to 192.168.102.37:22\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("ul",[a("li",[t._v("通过iptables实现局域网内不同网段间的两台主机的互联网共享.")])]),t._v(" "),a("p",[t._v("假如A主机IP192.168.0.5／192.168.2.5（双网卡）可以上网，B主机IP192.168.2.100不能上网")]),t._v(" "),a("p",[t._v("首先确保A和B要能相互ping通，A主机能上网")]),t._v(" "),a("p",[t._v("然后把B主机的IP网关设置成192.168.2.5，DNS设置成和主机A的DNS一样")]),t._v(" "),a("p",[t._v("开始添加修改主机A的iptables规则")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("#echo 0 > /proc/sys/net/ipv4/ip_forward\n//echo 'net.ipv4.ip_forward=1'>>/etc/sysctl.conf\n\n//修改/etc/sysctl.conf配置文件，可以实现永久有效规则\n\n//首先开启主机A的路由转发功能\n\n#iptables -t nat -A POSTROUTING -s 192.168.2.100 -p tcp --dport 80 -j SNAT --to-source 192.168.0.5\n\n//将主机B访问主机A的80端口上的数据转发到主机A另一个能访问外网的网卡上ip是192.168.0.5，\n其中-p tcp --dport 80 可以不写，就变成访问A的所有端口数据都转到ip为192.168.0.5的网卡上，借由这个网卡再加上路由功能转的开启，从而实现连接外网。\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br")])]),a("ul",[a("li",[t._v("实现A可以ping能B，B无法ping通A（只是回应拒绝访问）")])]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("#iptables -A INPUT -p icmp --icmp-type echo-request -j REJECT\n//在主机A上添加上面规则\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("ul",[a("li",[t._v("实现禁止路由访问代理服务器后面的服务器主机")])]),t._v(" "),a("p",[t._v("在代理服务器开启路由转发的前提下")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("# iptables -I FORWARD -s 192.168.2.200 -p tcp --dport 80 -j DROP\n\n//192.168.2.200是要访问server的客户机，当客户机通过server访问80转发端口时丢弃数据包\n\n#iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT\n\n//如上例，添加一条入站规则：对进来的包的状态进行检测。已经建立tcp连接的包以及该连接相关的包允许通过！\n\n//ESTABLISHED：已建立的链接状态。RELATED：该数据包与本机发出的数据包有关。\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br")])]),a("ul",[a("li",[t._v("防止骇客使用洪水攻击")])]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("#iptables -A INPUT -m limit --limit 3/hour\n\n//用来比对某段时间内封包的平均流量，上面的例子是用来比对：每小时平均流量是\n否超过一次 3 个封包。 除了每小时平均次外，也可以每秒钟、每分钟或每天平均一次，\n默认值为每小时均一次，参数如后：/second、/minute、/day。除了进行封数量的\n比对外，设定这个参数也会在条件达成时，暂停封包的比对动作，以避免因骇客使用洪水\n攻击法，导致服务被阻断\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("#iptables -A INPUT -p tcp --dport 80 -m limit --limit 25/minute --limit-burst 100 -j ACCEPT\n\n//--litmit-burst 100 指示当总连接数超过100时，启动 litmit/minute 限制\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("ul",[a("li",[t._v("配置web流量均衡\n我们可以将一台服务器作为前端服务器，利用iptables进行流量分发，配置方法如下：")])]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("iptables -A PREROUTING -i eth0 -p tcp --dport 80 -m state --state NEW -m nth --counter 0 --every 3 --packet 0 -j DNAT --to-destination 192.168.1.101:80\niptables -A PREROUTING -i eth0 -p tcp --dport 80 -m state --state NEW -m nth --counter 0 --every 3 --packet 0 -j DNAT --to-destination 192.168.1.102:80\niptables -A PREROUTING -i eth0 -p tcp --dport 80 -m state --state NEW -m nth --counter 0 --every 3 --packet 0 -j DNAT --to-destination 192.168.1.103:80\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("p",[t._v("以上配置规则用到nth扩展模块，将80端口的流量均衡到三台服务器。")]),t._v(" "),a("ul",[a("li",[t._v("将丢弃包情况记入日志")])]),t._v(" "),a("p",[t._v("使用LOG目标和syslog服务，我们可以记录某协议某端口下的收发包情况。拿记录丢包情况举例，可以通过以下方式实现。")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('首先自定义一个chain：\niptables -N LOGGING\n\n其次将所有接收包导入LOGGING chain中：\niptables -A INPUT -j LOGGING\n\n然后设置日志前缀、日志级别：\niptables -A LOGGING -m limit --limit 2/min -j LOG --log-prefix "IPTables Packet Dropped: " --log-level 7\n最后将包倒向DROP，将包丢弃：\n\niptables -A LOGGING -j DROP\n另可以配置syslog.conf文件，指定iptables的日志输出。\n')])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br")])]),a("h2",{attrs:{id:"规则管理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#规则管理"}},[t._v("#")]),t._v(" 规则管理")]),t._v(" "),a("ul",[a("li",[t._v("iptables的默认配置文件路径：/etc/sysconfig/iptables")])]),t._v(" "),a("h3",{attrs:{id:"永久保存"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#永久保存"}},[t._v("#")]),t._v(" 永久保存")]),t._v(" "),a("p",[t._v("当你删除、添加规则后，这些更改并不能永久生效，这些规则很有可能在系统重启后恢复原样。为了让配置永久生效，根据平台的不同，具体操作也不同。")]),t._v(" "),a("ul",[a("li",[t._v("Ubuntu")])]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("首先，保存现有的规则：\niptables-save > /etc/iptables.rules\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[t._v("然后新建一个bash脚本，并保存到/etc/network/if-pre-up.d/目录下：")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("#!/bin/bash\niptables-restore < /etc/iptables.rules\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[t._v("这样，每次系统重启后iptables规则都会被自动加载。")]),t._v(" "),a("blockquote",[a("p",[t._v("注意：不要尝试在.bashrc或者.profile中执行以上命令，因为用户通常不是root，而且这只能在登录时加载iptables规则。")])]),t._v(" "),a("ul",[a("li",[t._v("CentOS, RedHat")])]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("# 保存iptables规则\nservice iptables save\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("h3",{attrs:{id:"查看当前规则"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查看当前规则"}},[t._v("#")]),t._v(" 查看当前规则")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("cat  /etc/sysconfig/iptables\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("hr"),t._v(" "),a("blockquote",[a("p",[t._v("referred from:https://blog.csdn.net/cbuy888/article/details/80383770")])])])}),[],!1,null,null,null);s.default=n.exports}}]);